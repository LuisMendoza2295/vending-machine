# vending-machine
This project consists in two applications (admin and machine), which allows the execution of a vending-machine process

## Requisites
- Have **docker** installed in your host
- Have **docker-compose** version > 3.2 **(optional for default use)**

## Instructions
### Default use
This repo contains a **docker-compose.yml** file, which will set up a new application environment (one admin container and two machine containers, one per machine model)
This will create the following:
- PostgreSQL container bind to port **5432** on the host, and with default database as **vending_db**
- SpringBoot java container bind to port **8080** on the host for **admin** application
- SpringBoot java container bind to port **8081** on the host for **machine** application (with machine ID = M001)
- SpringBoot java container bind to port **8082** on the host for **machine** application (with machine ID = M002)

**IMPORTANT**:
**Make sure to have those ports unassigned in your host**

To create the default set up execute the following command from the **vending-machine root folder**

    $ docker-compose up -d

Check the created containers and sure you have the following containers in your host

    $ docker ps
    luismendoza2295/vending-machine   "java -jar /machine-…"   2 minutes ago   Up 2 minutes    0.0.0.0:8081->8080/tcp    vending-machine-container-m001
    luismendoza2295/vending-machine   "java -jar /machine-…"   2 minutes ago   Up 2 minutes    0.0.0.0:8082->8080/tcp    vending-machine-container-m002
    luismendoza2295/vending-admin     "java -jar /admin-ap…"   2 minutes ago   Up 2 minutes    0.0.0.0:8080->8080/tcp    vending-admin-container
    postgres:latest                   "docker-entrypoint.s…"   2 minutes ago   Up 2 minutes    0.0.0.0:5432->5432/tcp    vending-admin-db

Check your admin container by calling the **test** endpoint

    $ curl http://localhost:8080/admin/test
    Hello from Admin

Check your machine containers by calling the **test** endpoint

    $ curl http://localhost:8081/machine/test
    Hello from Machine
    $ curl http://localhost:8082/machine/test
    Hello from Machine

### Custom initialization

Start your database container (you can follow the official postgres documentation https://hub.docker.com/_/postgres)

    docker run --name some-postgres -e POSTGRES_PASSWORD=mysecretpassword -d postgres

Create the machines table in the database

    CREATE TABLE vending_machine
    (
        vending_machine_id BIGINT GENERATED BY DEFAULT AS IDENTITY CONSTRAINT vending_machine_pkey PRIMARY KEY ,
        access_attempts    INTEGER,
        access_code        VARCHAR (255),
        code               VARCHAR (255) CONSTRAINT uk_vending_machine_code UNIQUE,
        last_money_pickup  TIMESTAMP,
        last_ping          TIMESTAMP,
        status             VARCHAR (255),
        type               VARCHAR (255)
    );

Create as many machines as you need in the database **(code is unique)**

    INSERT INTO vending_machine(access_attempts, access_code, code, last_money_pickup, last_ping, status, type)
    VALUES (0, '0000', 'M001', current_timestamp, current_timestamp, 'OK', 'XYZ1');

Run the admin container

    docker run --name vending-admin-container \
    -e SPRING_DATASOURCE_URL=jdbc:postgresql://{your_postgres_container}:{your_postgres_port}/{your_postgres_db} \
    -e SPRING_DATASOURCE_USERNAME={your_postgres_user} \
    -e SPRING_DATASOURCE_PASSWORD={your_postgres_password} \
    luismendoza2295/vending-admin

Run the machine container (as many as you need)

    docker run --name vending-machine-container-{machine_code} \
    -e VENDING_MACHINE_ID={machine_code} \
    -e VENDING_MACHINE_ADMIN-URL=http://vending-admin-container:{your_admin_port}/admin \
    luismendoza2295/vending-machine

Check your admin container

    $ curl http://localhost:{your_admin_port}/admin/actuator/health
    {
        "status": "UP"
    }

Check your machine containers

    $ curl http://localhost:{your_machine_port}/machine/actuator/health
    {
        "status": "UP"
    }

## Usage
These examples use the default setup (machine and product codes)

### Machine

- **Cash purchase**
    - Request
      
            curl --location --request POST 'http://{your_machine_container}:{your_machine_port}/machine/cash' \
            --header 'Content-Type: application/json' \
            --data-raw '{
                "product": "P001",
                "cash": {
                    "ONE_DOLLAR": 1,
                    "FIFTY_CENT": 2,
                    "TWENTY_FIVE_CENT": 3
                }
            }'
    - Response

            {
                "product": "P001",
                "change": {
                    "FIFTY_CENT": 1
                }
            }
   
- **Card purchase**
    - Request
      
            curl --location --request POST 'http://{your_machine_container}:{your_machine_port}/machine/card' \
            --header 'Content-Type: application/json' \
            --data-raw '{
                "product": "P002",
                "issuer": "12345678"
            }'
    - Response
      
            {
                "uuid": "a04f689c-5618-4d34-a2a3-51412ca28345",
                "issuer": "12345678",
                "amount": 2.50,
                "dateTime": "2020-12-23T06:25:48.896",
                "product": "P001",
                "vendingMachine": "M002"
            }
    
- **Open machine**
    - Request
    
            curl --location --request POST 'http://{your_machine_container}:{your_machine_port}/machine/open?accessCode=0000'
    - Response 
  
            true

- **Close machine**
    - Request
    
            curl --location --request POST 'http://{your_machine_container}:{your_machine_port}/machine/close'
    - Response
    
            true
    
### Admin
#### Products
- **Get all products**
    - Request
    
            curl --location --request GET 'http://{your_admin_container}:{your_admin_port}/admin/products'
    - Response
      
            [
                {
                    "code": "P002",
                    "name": "Lays Small",
                    "price": 0.75
                },
                {
                    "code": "P003",
                    "name": "Lays Medium",
                    "price": 1.75
                },
                {
                    "code": "P004",
                    "name": "Lays Large",
                    "price": 2.25
                },
                {
                    "code": "P001",
                    "name": "M&M",
                    "price": 1.5
                }
            ]

- **Create a product**
    - Request
    
            curl --location --request POST 'http://{your_admin_container}:{your_admin_port}/admin/products' \
            --header 'Content-Type: application/json' \
            --data-raw '{
                "code": "P001",
                "name": "M&M",
                "price": 1.5
            }'
    - Response
    
            {
                "code": "P001",
                "name": "M&M",
                "price": 1.5
            }
    
- **Change product price**
    - Request
    
            curl --location --request PATCH 'http://{your_admin_container}:{your_admin_port}/admin/products/P001/price?price=1.25'
    - Response
    
            {
                "code": "P001",
                "name": "M&M",
                "price": 1.25
            }
    
#### Machine
- **Get by Machine Code**
    - Request
    
            curl --location --request GET 'http://{your_admin_container}:{your_admin_port}/admin/vending-machine/M001'
    - Response
            
            {
                "code": "M001",
                "status": "OK",
                "type": "XYZ1",
                "lastMoneyPickUp": "2020-12-23T04:55:33.595052",
                "connected": true,
                "products": {
                    "P001": 10,
                    "P002": 15
                },
                "prices": {
                    "P001": 2.50,
                    "P002": 0.75
                },
                "vault": {
                    "FIFTY_CENT": 0,
                    "TWO_DOLLAR": 0,
                    "FIVE_CENT": 0,
                    "TWENTY_FIVE_CENT": 0,
                    "TEN_CENT": 0,
                    "ONE_DOLLAR": 0
                }
            }
    
- **Create Machine**
    - Request
            
            curl --location --request POST 'http://{your_admin_container}:{your_admin_port}/admin/vending-machine' \
            --header 'Content-Type: application/json' \
            --data-raw '{
                "code": "M003",
                "type": "XYZ1"
            }'
    - Response
    
            {
                "code": "M003",
                "status": "OK",
                "type": "XYZ1",
                "lastMoneyPickUp": "2020-12-23T06:45:09.814",
                "connected": true,
                "products": {},
                "prices": {},
                "vault": {
                    "FIFTY_CENT": 0,
                    "TWO_DOLLAR": 0,
                    "FIVE_CENT": 0,
                    "TWENTY_FIVE_CENT": 0,
                    "ONE_DOLLAR": 0,
                    "TEN_CENT": 0
                }
            }
    
- **Change Machine Access Code**
    - Request
    
            curl --location --request PATCH 'http://{your_admin_container}:{your_admin_port}/admin/vending-machine/M003/access-code?accessCode=1122'
    - Response
    
            {
                "code": "M003",
                "status": "OK",
                "type": "XYZ1",
                "lastMoneyPickUp": "2020-12-23T06:45:09.814",
                "connected": false,
                "products": {},
                "prices": {},
                "vault": {
                    "FIFTY_CENT": 0,
                    "TWO_DOLLAR": 0,
                    "FIVE_CENT": 0,
                    "TWENTY_FIVE_CENT": 0,
                    "ONE_DOLLAR": 0,
                    "TEN_CENT": 0
                }
            }
    
- **Put Product to Machine**
    - Request
    
            curl --location --request PATCH 'http://{your_admin_container}:{your_admin_port}/admin/vending-machine/M003/put-products' \
            --header 'Content-Type: application/json' \
            --data-raw '{
                "productCount": {
                    "P001": 10,
                    "P002": 15
                }
            }'
    - Response
    
            {
                "code": "M003",
                "status": "OK",
                "type": "XYZ1",
                "lastMoneyPickUp": "2020-12-23T06:45:09.814",
                "connected": false,
                "products": {
                    "P001": 10,
                    "P002": 15
                },
                "prices": {
                    "P001": 1.25,
                    "P002": 0.75
                },
                "vault": {
                    "FIFTY_CENT": 0,
                    "TWO_DOLLAR": 0,
                    "FIVE_CENT": 0,
                    "TWENTY_FIVE_CENT": 0,
                    "ONE_DOLLAR": 0,
                    "TEN_CENT": 0
                }
            }
    
- **Remove Product from Machine**
    - Request
      
            curl --location --request PATCH 'http://{your_admin_container}:{your_admin_port}/admin/vending-machine/M003/remove-product?productCode=P001'
    - Response
    
            {
                "code": "M003",
                "status": "OK",
                "type": "XYZ1",
                "lastMoneyPickUp": "2020-12-23T06:45:09.814",
                "connected": false,
                "products": {
                    "P002": 15
                },
                "prices": {
                    "P002": 0.75
                },
                "vault": {
                    "FIFTY_CENT": 0,
                    "TWO_DOLLAR": 0,
                    "FIVE_CENT": 0,
                    "TWENTY_FIVE_CENT": 0,
                    "ONE_DOLLAR": 0,
                    "TEN_CENT": 0
                }
            }
    
- **Put Money in Machine Vault**
    - Request
    
            curl --location --request PATCH 'http://{your_admin_container}:{your_admin_port}/admin/vending-machine/M003/vault' \
            --header 'Content-Type: application/json' \
            --data-raw '{
                "denominationCount": {
                    "FIFTY_CENT": 20,
                    "TWO_DOLLAR": 15,
                    "FIVE_CENT": 10,
                    "TWENTY_FIVE_CENT": 0,
                    "TEN_CENT": 5,
                    "ONE_DOLLAR": 50
                }
            }'
    - Response
    
            {
                "code": "M003",
                "status": "OK",
                "type": "XYZ1",
                "lastMoneyPickUp": "2020-12-23T06:45:09.814",
                "connected": false,
                "products": {
                    "P002": 15
                },
                "prices": {
                    "P002": 0.75
                },
                "vault": {
                    "FIFTY_CENT": 20,
                    "TWO_DOLLAR": 15,
                    "FIVE_CENT": 10,
                    "TWENTY_FIVE_CENT": 0,
                    "ONE_DOLLAR": 50,
                    "TEN_CENT": 5
                }
            }
    
####
- **Get all Transactions**
    - Request
    
            curl --location --request GET 'http://{your_admin_container}:{your_admin_port}/admin/transactions?from=2020-12-21&to=2020-12-23&pageNumber=0&pageSize=5'
    - Response
    
            [
                {
                    "transactionID": "a04f689c-5618-4d34-a2a3-51412ca28345",
                    "productID": "P001",
                    "vendingMachineID": "M002",
                    "amount": 2.50,
                    "dateTime": "2020-12-23T06:25:48.896",
                    "type": "CARD",
                    "issuer": "12345678",
                    "insertedDenomination": {}
                },
                {
                    "transactionID": "eb400e12-0089-4df4-a7a2-3b2bf10d5eaa",
                    "productID": "P001",
                    "vendingMachineID": "M002",
                    "amount": 2.50,
                    "dateTime": "2020-12-23T06:22:14.866",
                    "type": "CASH",
                    "issuer": "CASH",
                    "insertedDenomination": {
                        "ONE_DOLLAR": 3
                    }
                },
                {
                    "transactionID": "ea4dd5c2-75bc-40ab-84da-fb63d624ab55",
                    "productID": "P001",
                    "vendingMachineID": "M002",
                    "amount": 2.50,
                    "dateTime": "2020-12-23T06:21:09.582",
                    "type": "CASH",
                    "issuer": "CASH",
                    "insertedDenomination": {
                        "FIFTY_CENT": 2,
                        "TWENTY_FIVE_CENT": 3,
                        "ONE_DOLLAR": 1
                    }
                },
                {
                    "transactionID": "6bd2c8b5-380a-4a14-a2d8-b352d108ac9a",
                    "productID": "P001",
                    "vendingMachineID": "M002",
                    "amount": 2.50,
                    "dateTime": "2020-12-23T06:20:54.863",
                    "type": "CASH",
                    "issuer": "CASH",
                    "insertedDenomination": {
                        "FIFTY_CENT": 2,
                        "TWENTY_FIVE_CENT": 3,
                        "ONE_DOLLAR": 2
                    }
                }
            ]
    
- **Get total earnings**
    - Request
    
            curl --location --request GET 'http://{your_admin_container}:{your_admin_port}/admin/transactions/earnings?from=2020-12-22&to=2020-12-23'
    - Response
    
            10.00